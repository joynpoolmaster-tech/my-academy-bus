<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚗 기사님 스마트 내비게이션</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            user-select: none;
            -webkit-user-select: none;
        }
        .nav-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .nav-btn:active {
            transform: translateY(0px);
            transition: all 0.1s ease;
        }
        .student-card {
            border-left: 5px solid #3B82F6;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .student-card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .completed {
            border-left-color: #10B981;
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
        }
        .current {
            border-left-color: #F59E0B;
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5); }
        }
        .progress-bar {
            transition: width 0.8s ease;
        }
        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .route-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .navi-modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.8);
        }
        .bounce-in {
            animation: bounceIn 0.5s ease;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .nav-option {
            transition: all 0.3s ease;
            border-radius: 16px;
            background: white;
            border: 2px solid transparent;
        }
        .nav-option:hover {
            border-color: #3B82F6;
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- 헤더 -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 sticky top-0 z-50 shadow-xl">
        <div class="max-w-lg mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold flex items-center">
                        🚗 스마트 내비게이션
                        <span class="ml-2 px-2 py-1 bg-white/20 rounded-full text-xs">LIVE</span>
                    </h1>
                    <p class="text-sm opacity-90" id="headerInfo">2025년 8월 7일 / 1호차 (김기사님)</p>
                </div>
                <div class="text-right">
                    <div class="text-xs opacity-90">진행률</div>
                    <div class="text-lg font-bold" id="progressInfo">0/5</div>
                </div>
            </div>
            <!-- 진행률 바 -->
            <div class="mt-3 bg-white/20 rounded-full h-2 overflow-hidden">
                <div class="progress-bar bg-white h-full rounded-full" style="width: 0%" id="progressBar"></div>
            </div>
        </div>
    </header>

    <div class="max-w-lg mx-auto">
        <!-- 경로 요약 카드 -->
        <div class="route-summary text-white p-6 m-4 rounded-2xl shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm opacity-90">예상 소요시간</div>
                    <div class="text-3xl font-bold" id="totalTime">45분</div>
                </div>
                <div class="text-right">
                    <div class="text-sm opacity-90">총 거리</div>
                    <div class="text-xl font-bold" id="totalDistance">12.5km</div>
                </div>
            </div>
            <div class="mt-4 flex space-x-3">
                <button onclick="optimizeRoute()" class="flex-1 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-xl px-4 py-2 text-sm font-medium transition">
                    📍 경로 최적화
                </button>
                <button onclick="startNavigation()" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl px-4 py-2 text-sm font-bold transition">
                    🚀 전체 출발
                </button>
            </div>
        </div>

        <!-- 학생 목록 -->
        <div class="p-4 space-y-4" id="studentList">
            <!-- 학생 카드들이 동적으로 추가됩니다 -->
        </div>
    </div>

    <!-- 플로팅 컨트롤 -->
    <div class="floating-controls">
        <button onclick="emergencyCall()" class="bg-red-500 hover:bg-red-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center mb-3 transition">
            🚨
        </button>
        <button onclick="toggleGPS()" class="bg-green-500 hover:bg-green-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition" id="gpsBtn">
            📍
        </button>
    </div>

    <!-- 내비게이션 선택 모달 -->
    <div id="naviModal" class="navi-modal fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 bounce-in">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">🗺️</div>
                    <h3 class="text-xl font-bold text-gray-800">내비게이션 선택</h3>
                    <p class="text-sm text-gray-600 mt-1" id="selectedStudent">홍길동님 집으로 안내</p>
                </div>
                
                <div class="space-y-3" id="naviOptions">
                    <!-- 내비게이션 옵션들 -->
                </div>
                
                <button onclick="closeNaviModal()" class="w-full mt-6 py-3 text-gray-600 hover:text-gray-800 transition font-medium">
                    취소
                </button>
            </div>
        </div>
    </div>

    <!-- 완료 확인 모달 -->
    <div id="completeModal" class="navi-modal fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 bounce-in">
            <div class="p-6 text-center">
                <div class="text-6xl mb-4">🎉</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">픽업 완료!</h3>
                <p class="text-gray-600 mb-6" id="completedStudentName">홍길동님을 픽업했습니다</p>
                <div class="flex space-x-3">
                    <button onclick="closeCompleteModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-xl font-medium transition">
                        취소
                    </button>
                    <button onclick="confirmComplete()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold transition">
                        완료 확인
                    </button>
                </div>
            </div>
        </div>
    </div>

        let currentStudentIndex = 0;
        let selectedStudentForNavi = null;
        let gpsEnabled = false;

        // 내비게이션 앱 정보
        const naviApps = [
            {
                name: '카카오네비',
                icon: '🟨',
                scheme: 'kakaonavi://route?destination=',
                fallback: 'https://map.kakao.com/link/to/',
                description: '실시간 교통정보'
            },
            {
                name: '네이버지도',
                icon: '🟢',
                scheme: 'nmap://route/walk?dlat={lat}&dlng={lng}&dname=',
                fallback: 'https://map.naver.com/v5/search/',
                description: '정확한 도로정보'
            },
            {
                name: '구글맵',
                icon: '🔵',
                scheme: 'comgooglemaps://?daddr=',
                fallback: 'https://maps.google.com/maps?q=',
                description: '글로벌 표준'
            },
            {
                name: '티맵',
                icon: '🔴',
                scheme: 'tmap://route?goalname=목적지&goalx={lng}&goaly={lat}',
                fallback: 'https://www.tmap.co.kr',
                description: '정밀한 내비게이션'
            },
            {
                name: '애플맵',
                icon: '🍎',
                scheme: 'http://maps.apple.com/?daddr=',
                fallback: 'http://maps.apple.com/?q=',
                description: 'iOS 기본 내비'
            }
        ];

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            renderStudentList();
            updateProgress();
            updateHeaderInfo();
            
            // 현재 위치 권한 요청
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        gpsEnabled = true;
                        updateGPSButton();
                        console.log('GPS 활성화됨');
                    },
                    error => {
                        console.log('GPS 권한 거부됨');
                    }
                );
            }
        });

        // 학생 목록 렌더링
        function renderStudentList() {
            const container = document.getElementById('studentList');
            container.innerHTML = '';

            routeData.students.forEach((student, index) => {
                const isCompleted = student.status === 'completed';
                const isCurrent = student.status === 'current' || (currentStudentIndex === index && student.status === 'pending');
                
                if (isCurrent && student.status !== 'current') {
                    student.status = 'current';
                }

                const cardClass = isCompleted ? 'completed' : (isCurrent ? 'current' : '');
                const statusIcon = isCompleted ? '✅' : (isCurrent ? '🚗' : '⏱️');
                const statusText = isCompleted ? '완료' : (isCurrent ? '진행중' : '대기중');

                const card = document.createElement('div');
                card.className = `student-card bg-white p-5 rounded-2xl shadow-lg ${cardClass}`;
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg mr-4">
                                ${index + 1}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <h3 class="font-bold text-lg text-gray-800">${student.name}</h3>
                                    <span class="ml-2 text-sm">${statusIcon}</span>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">${student.address}</p>
                                <div class="flex items-center mt-2 space-x-4">
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">📍 ${student.distance}</span>
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">⏱️ ${student.estimatedTime}</span>
                                    <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex space-x-2">
                        ${!isCompleted ? `
                            <button onclick="openNavigation(${student.id})" class="nav-btn flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-xl transition">
                                🗺️ 길찾기
                            </button>
                            <button onclick="callStudent('${student.phone}')" class="nav-btn bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl transition">
                                📞
                            </button>
                            ${isCurrent ? `
                                <button onclick="completePickup(${student.id})" class="nav-btn bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-xl transition">
                                    ✅
                                </button>
                            ` : ''}
                        ` : `
                            <div class="flex-1 bg-green-100 text-green-800 py-3 rounded-xl text-center font-medium">
                                ✅ 픽업 완료
                            </div>
                        `}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // 내비게이션 앱 선택 모달 열기
        function openNavigation(studentId) {
            selectedStudentForNavi = routeData.students.find(s => s.id === studentId);
            if (!selectedStudentForNavi) return;

            document.getElementById('selectedStudent').textContent = `${selectedStudentForNavi.name}님 집으로 안내`;
            
            const optionsContainer = document.getElementById('naviOptions');
            optionsContainer.innerHTML = '';

            naviApps.forEach(app => {
                const option = document.createElement('button');
                option.className = 'nav-option w-full flex items-center p-4 transition';
                option.onclick = () => launchNavigation(app);
                
                option.innerHTML = `
                    <div class="w-12 h-12 flex items-center justify-center text-2xl mr-4">
                        ${app.icon}
                    </div>
                    <div class="text-left flex-1">
                        <div class="font-bold text-gray-800">${app.name}</div>
                        <div class="text-sm text-gray-600">${app.description}</div>
                    </div>
                    <div class="text-blue-500 font-bold">실행</div>
                `;
                
                optionsContainer.appendChild(option);
            });

            document.getElementById('naviModal').classList.remove('hidden');
        }

        // 내비게이션 앱 실행
        function launchNavigation(app) {
            if (!selectedStudentForNavi) return;

            const address = selectedStudentForNavi.address;
            let url;

            try {
                // 앱 스킴으로 시도
                if (app.name === '카카오네비') {
                    url = app.scheme + encodeURIComponent(address);
                } else if (app.name === '네이버지도') {
                    url = app.fallback + encodeURIComponent(address);
                } else if (app.name === '구글맵') {
                    url = app.fallback + encodeURIComponent(address);
                } else if (app.name === '티맵') {
                    url = app.fallback;
                } else if (app.name === '애플맵') {
                    url = app.scheme + encodeURIComponent(address);
                }

                // 앱 실행 시도
                window.location.href = url;
                
                // 잠시 후 폴백 URL로 리다이렉트 (앱이 설치되지 않은 경우)
                setTimeout(() => {
                    if (app.fallback && app.fallback !== url) {
                        window.open(app.fallback + encodeURIComponent(address), '_blank');
                    }
                }, 1000);

                closeNaviModal();
                
                // 진동 피드백 (지원하는 기기에서)
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }

                showToast(`${app.name}으로 ${selectedStudentForNavi.name}님 집 안내를 시작합니다! 🚗`);

            } catch (error) {
                console.error('내비게이션 실행 오류:', error);
                showToast('내비게이션 앱을 실행할 수 없습니다. 앱이 설치되어 있는지 확인해주세요.', 'error');
            }
        }

        // 학생에게 전화걸기
        function callStudent(phone) {
            if (confirm(`${phone}로 전화를 걸까요?`)) {
                window.location.href = `tel:${phone}`;
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }
            }
        }

        // 픽업 완료 처리
        function completePickup(studentId) {
            const student = routeData.students.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('completedStudentName').textContent = `${student.name}님을 픽업했습니다`;
            document.getElementById('completeModal').classList.remove('hidden');
        }

        // 픽업 완료 확인
        function confirmComplete() {
            const student = routeData.students.find(s => s.status === 'current');
            if (student) {
                student.status = 'completed';
                currentStudentIndex++;
                
                renderStudentList();
                updateProgress();
                
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                showToast(`${student.name}님 픽업이 완료되었습니다! 🎉`);
                
                // 다음 학생으로 자동 이동
                if (currentStudentIndex < routeData.students.length) {
                    setTimeout(() => {
                        const nextStudent = routeData.students[currentStudentIndex];
                        showToast(`다음 목적지: ${nextStudent.name}님 (${nextStudent.estimatedTime})`, 'info');
                    }, 2000);
                } else {
                    setTimeout(() => {
                        showToast('🎉 모든 픽업이 완료되었습니다! 수고하셨습니다!', 'success');
                    }, 2000);
                }
            }
            
            closeCompleteModal();
        }

        // 진행률 업데이트
        function updateProgress() {
            const completed = routeData.students.filter(s => s.status === 'completed').length;
            const total = routeData.students.length;
            const percentage = (completed / total) * 100;
            
            document.getElementById('progressInfo').textContent = `${completed}/${total}`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }

        // 헤더 정보 업데이트
        function updateHeaderInfo() {
            document.getElementById('headerInfo').textContent = 
                `${routeData.date} / ${routeData.vehicle} (${routeData.driver}님)`;
        }

        // 경로 최적화
        function optimizeRoute() {
            showToast('경로를 최적화하고 있습니다... 🔄');
            
            // 실제로는 서버에서 최적화된 경로를 받아옴
            setTimeout(() => {
                showToast('경로 최적화가 완료되었습니다! 약 8분 단축 예상 ⚡', 'success');
                document.getElementById('totalTime').textContent = '37분';
            }, 2000);
        }

        // 전체 경로 시작
        function startNavigation() {
            if (routeData.students.filter(s => s.status === 'pending' || s.status === 'current').length === 0) {
                showToast('모든 픽업이 완료되었습니다! 🎉', 'success');
                return;
            }
            
            const firstPendingStudent = routeData.students.find(s => s.status === 'pending' || s.status === 'current');
            if (firstPendingStudent) {
                openNavigation(firstPendingStudent.id);
            }
        }

        // 응급상황 처리
        function emergencyCall() {
            if (confirm('응급상황입니다. 관리센터에 연락하시겠습니까?')) {
                window.location.href = 'tel:02-1234-5678';
                showToast('관리센터에 연결 중입니다... 🚨', 'error');
            }
        }

        // GPS 토글
        function toggleGPS() {
            if (gpsEnabled) {
                // GPS 현재 위치 가져오기
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            showToast(`현재 위치: ${lat.toFixed(6)}, ${lng.toFixed(6)} 📍`);
                        },
                        error => {
                            showToast('위치 정보를 가져올 수 없습니다.', 'error');
                        }
                    );
                }
            } else {
                showToast('GPS 기능이 비활성화되어 있습니다.', 'error');
            }
        }

        // GPS 버튼 상태 업데이트
        function updateGPSButton() {
            const btn = document.getElementById('gpsBtn');
            if (gpsEnabled) {
                btn.classList.remove('bg-gray-400');
                btn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                btn.classList.add('bg-gray-400');
            }
        }

        // 모달 닫기 함수들
        function closeNaviModal() {
            document.getElementById('naviModal').classList.add('hidden');
            selectedStudentForNavi = null;
        }

        function closeCompleteModal() {
            document.getElementById('completeModal').classList.add('hidden');
        }

        // 토스트 메시지 표시
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 
                           type === 'success' ? 'bg-green-500' : 
                           'bg-blue-500';
            
            toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 opacity-0`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 애니메이션
            setTimeout(() => {
                toast.classList.remove('opacity-0');
                toast.classList.add('opacity-100');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // 모달 외부 클릭시 닫기
        document.addEventListener('click', function(event) {
            if (event.target.id === 'naviModal') {
                closeNaviModal();
            }
            if (event.target.id === 'completeModal') {
                closeCompleteModal();
            }
        });

        // 키보드 단축키
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeNaviModal();
                closeCompleteModal();
            }
        });

        // PWA 관련 기능
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            deferredPrompt = e;
            showToast('앱으로 설치하여 더 편리하게 사용하세요! 📱');
        });

        // 페이지 가시성 변경 감지 (백그라운드/포그라운드)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('앱이 백그라운드로 이동됨');
            } else {
                console.log('앱이 포그라운드로 복귀됨');
                // 데이터 새로고침
                updateProgress();
            }
        });

        // 배터리 상태 모니터링 (지원하는 기기에서)
        if ('getBattery' in navigator) {
            navigator.getBattery().then(function(battery) {
                if (battery.level < 0.2) {
                    showToast('배터리가 부족합니다! 충전기를 준비해주세요 🔋', 'error');
                }
            });
        }

        // 네트워크 상태 모니터링
        window.addEventListener('online', function() {
            showToast('인터넷 연결이 복구되었습니다! 🌐', 'success');
        });

        window.addEventListener('offline', function() {
            showToast('인터넷 연결이 끊어졌습니다. 일부 기능이 제한될 수 있습니다 📵', 'error');
        });

        // 화면 방향 변경 감지
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                renderStudentList(); // 화면 방향 변경 후 레이아웃 재조정
            }, 500);
        });

        // 터치 제스처 (스와이프로 다음/이전 학생)
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 100;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // 왼쪽으로 스와이프 - 다음 학생
                    goToNextStudent();
                } else {
                    // 오른쪽으로 스와이프 - 이전 학생
                    goToPreviousStudent();
                }
            }
        }

        function goToNextStudent() {
            if (currentStudentIndex < routeData.students.length - 1) {
                const currentStudent = routeData.students[currentStudentIndex];
                if (currentStudent.status === 'current') {
                    currentStudent.status = 'completed';
                }
                currentStudentIndex++;
                renderStudentList();
                updateProgress();
                
                const nextStudent = routeData.students[currentStudentIndex];
                showToast(`다음: ${nextStudent.name}님 📍`);
            }
        }

        function goToPreviousStudent() {
            if (currentStudentIndex > 0) {
                const currentStudent = routeData.students[currentStudentIndex];
                if (currentStudent.status === 'current') {
                    currentStudent.status = 'pending';
                }
                currentStudentIndex--;
                
                const prevStudent = routeData.students[currentStudentIndex];
                prevStudent.status = 'current';
                
                renderStudentList();
                updateProgress();
                showToast(`이전: ${prevStudent.name}님 📍`);
            }
        }

        // 음성 안내 기능 (Web Speech API)
        function speakMessage(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
            }
        }

        // 자동 새로고침 (실시간 업데이트)
        setInterval(function() {
            // 실제 환경에서는 서버에서 최신 배차 정보를 가져옴
            console.log('데이터 동기화 중...');
        }, 30000); // 30초마다

        // 서비스 워커 등록 (오프라인 지원)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker 등록 성공:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker 등록 실패:', error);
                    });
            });
        }

        // 긴급 상황용 SOS 기능
        let sosClickCount = 0;
        let sosTimer;

        function activateSOS() {
            sosClickCount++;
            clearTimeout(sosTimer);
            
            if (sosClickCount === 1) {
                showToast('SOS 모드: 3초 안에 3번 더 누르면 긴급호출됩니다!', 'error');
            }
            
            if (sosClickCount >= 3) {
                // 긴급 호출 실행
                showToast('🚨 긴급 상황! 관리센터에 자동 연결됩니다!', 'error');
                window.location.href = 'tel:119';
                sosClickCount = 0;
                return;
            }
            
            sosTimer = setTimeout(() => {
                sosClickCount = 0;
            }, 3000);
        }

        // 화면 항상 켜두기 (Wake Lock API)
        let wakeLock = null;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('화면 꺼짐 방지 활성화');
                }
            } catch (err) {
                console.log('Wake Lock 오류:', err);
            }
        }

        // 앱 시작시 화면 켜두기 요청
        requestWakeLock();

        // 페이지 포커스 시 Wake Lock 재요청
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        // 실시간 위치 추적 시작/중지
        let watchId = null;

        function startLocationTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        console.log(`실시간 위치: ${lat}, ${lng}`);
                        // 실제로는 서버에 위치 정보 전송
                    },
                    error => {
                        console.log('위치 추적 오류:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }

        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        // 자동으로 위치 추적 시작
        if (gpsEnabled) {
            startLocationTracking();
        }

        // 브라우저 알림 권한 요청
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('알림이 활성화되었습니다! 📢');
                    }
                });
            }
        }

        // 푸시 알림 표시 함수
        function showNotification(title, body, icon = '🚗') {
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/icon-192x192.png',
                    badge: '/badge-72x72.png',
                    tag: 'driver-notification',
                    requireInteraction: true
                });
            }
        }

        // 예제: 다음 목적지 도착 알림
        function notifyArrival(studentName) {
            showNotification(
                '목적지 도착!',
                `${studentName}님 집에 도착했습니다. 픽업을 진행해주세요.`,
                '📍'
            );
            
            // 진동도 함께
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }

        // 커스텀 컨텍스트 메뉴 (길게 눌렀을 때)
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            showToast('🔧 개발자 도구가 비활성화되어 있습니다.');
        });

        // 더블탭으로 확대/축소 방지
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // 메모리 사용량 모니터링 (개발용)
        setInterval(() => {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1048576);
                if (used > 50) { // 50MB 이상시 경고
                    console.warn(`메모리 사용량: ${used}MB`);
                }
            }
        }, 60000);

        console.log('🚗 스마트 내비게이션 시스템이 완전히 로드되었습니다!');
        showToast('🚗 스마트 내비게이션 시스템 준비완료!', 'success');