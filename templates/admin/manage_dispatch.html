<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .tab-active {
            background-color: #3B82F6;
            color: white;
        }

        .tab-inactive {
            background-color: #F3F4F6;
            color: #6B7280;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .success-flash {
            background-color: #D1FAE5;
            color: #065F46;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .error-flash {
            background-color: #FEE2E2;
            color: #B91C1C;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <!-- ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="flashMessages"></div>

            <!-- í—¤ë” -->
            <div class="bg-white rounded-lg shadow-lg mb-6">
                <div class="bg-blue-600 text-white p-6 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-2xl font-bold">ğŸš ë°°ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                            <p class="mt-1 opacity-90">
                                {{ current_user.managed_branch.name if current_user.managed_branch else 'ë¯¸ì„¤ì •' }} ê´€ë¦¬ì ({{
                                current_user.name }}ë‹˜)
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm opacity-90">ì˜¤ëŠ˜ ë°°ì°¨ í˜„í™©</div>
                            <div class="text-xl font-bold" id="todayStatus">
                                ìš´í–‰ì¤‘ <span id="operatingCount">0</span>ëŒ€ /
                                ëŒ€ê¸° <span id="waitingCount">0</span>ëŒ€
                            </div>
                        </div>
                    </div>
                </div>

                <!-- íƒ­ ë©”ë‰´ -->
                <div class="flex border-b">
                    <button class="tab-btn tab-active px-6 py-3 font-medium transition" data-tab="regular">
                        ğŸ“‹ ì •ê·œ ë°°ì°¨
                    </button>
                    <button class="tab-btn tab-inactive px-6 py-3 font-medium transition" data-tab="special">
                        ğŸš¨ íŠ¹ë³„ ë°°ì°¨
                    </button>
                    <button class="tab-btn tab-inactive px-6 py-3 font-medium transition" data-tab="history">
                        ğŸ“Š ë°°ì°¨ ì´ë ¥
                    </button>
                </div>
            </div>

            <!-- ì •ê·œ ë°°ì°¨ íƒ­ -->
            <div id="regularTab" class="tab-content">
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- ë°°ì°¨ ì„¤ì • -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">ğŸ“… ì •ê·œ ë°°ì°¨ ìƒì„±</h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">ë°°ì°¨ ë‚ ì§œ</label>
                                    <input type="date" id="dispatchDate" value="{{ today_str }}"
                                        class="w-full border rounded-md px-3 py-2">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-1">í´ë˜ìŠ¤ ì„ íƒ</label>
                                    <select id="classSelect" class="w-full border rounded-md px-3 py-2">
                                        <option value="">ì „ì²´ í´ë˜ìŠ¤</option>
                                        {% for class_item in available_classes %}
                                        <option value="{{ class_item.name }}">
                                            {{ class_item.name }}
                                            {% if class_item.time_slots %}
                                            ({{ class_item.time_slots[0].time }})
                                            {% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-1">ë°°ì°¨ ì˜µì…˜</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="autoOptimize" checked class="mr-2">
                                            <span class="text-sm">ê²½ë¡œ ìë™ ìµœì í™”</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="autoAssign" checked class="mr-2">
                                            <span class="text-sm">ê¸°ì‚¬ ìë™ ë°°ì •</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <div class="text-sm text-blue-800 font-medium">ë°°ì°¨ ì˜ˆìƒ ì •ë³´</div>
                                    <div class="text-xs text-blue-600 mt-1" id="dispatchPreview">
                                        í´ë˜ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ ì˜ˆìƒ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤
                                    </div>
                                </div>

                                <button id="generateRegular"
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium">
                                    ğŸ“‹ ì •ê·œ ë°°ì°¨ ìƒì„±
                                </button>
                            </div>
                        </div>

                        <!-- ë¦¬ì†ŒìŠ¤ í˜„í™© -->
                        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                            <h3 class="text-lg font-semibold mb-4">ğŸš— ë¦¬ì†ŒìŠ¤ í˜„í™©</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">ê°€ìš© ê¸°ì‚¬</span>
                                    <span class="font-bold text-green-600" id="availableDrivers">{{
                                        available_drivers|length }}ëª…</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">ê°€ìš© ì°¨ëŸ‰</span>
                                    <span class="font-bold text-green-600" id="availableVehicles">{{
                                        available_vehicles|length }}ëŒ€</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">ëŒ€ê¸° í•™ìƒ</span>
                                    <span class="font-bold text-blue-600" id="waitingStudents">ì¡°íšŒì¤‘...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë°°ì°¨ í˜„í™© -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-4 border-b flex justify-between items-center">
                                <h3 class="text-lg font-semibold">ğŸ“Š ì˜¤ëŠ˜ ë°°ì°¨ í˜„í™©</h3>
                                <div class="flex gap-2">
                                    <button id="refreshDispatch"
                                        class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                                    </button>
                                    <button id="exportDispatch"
                                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                        ğŸ“„ ë‚´ë³´ë‚´ê¸°
                                    </button>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ë°°ì°¨ë²ˆí˜¸</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">í´ë˜ìŠ¤</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ê¸°ì‚¬/ì°¨ëŸ‰</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">í•™ìƒìˆ˜</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ìƒíƒœ</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ì•¡ì…˜</th>
                                        </tr>
                                    </thead>
                                    <tbody id="regularDispatchTable">
                                        <tr>
                                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                                ë°°ì°¨ ì •ë³´ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íŠ¹ë³„ ë°°ì°¨ íƒ­ -->
            <div id="specialTab" class="tab-content hidden">
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- íŠ¹ë³„ ë°°ì°¨ ìƒì„± -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">ğŸš¨ íŠ¹ë³„ ë°°ì°¨ ì‹ ì²­</h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">ë°°ì°¨ ìœ í˜•</label>
                                    <select id="specialType" class="w-full border rounded-md px-3 py-2">
                                        <option value="emergency">ê¸´ê¸‰ ë°°ì°¨</option>
                                        <option value="individual">ê°œë³„ ìš”ì²­</option>
                                        <option value="makeup">ë³´ê°• ìˆ˜ì—…</option>
                                        <option value="event">íŠ¹ë³„ í–‰ì‚¬</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-1">ì‹ ì²­ ë‚ ì§œ/ì‹œê°„</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="date" id="specialDate" value="{{ today_str }}"
                                            class="border rounded-md px-3 py-2">
                                        <input type="time" id="specialTime" class="border rounded-md px-3 py-2">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-1">ëŒ€ìƒ í•™ìƒ</label>
                                    <div class="space-y-2" id="studentSelector">
                                        <button type="button" id="addStudent"
                                            class="w-full border-2 border-dashed border-gray-300 rounded-lg p-3 text-gray-500 hover:border-blue-300 hover:text-blue-500 transition">
                                            + í•™ìƒ ì¶”ê°€
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-1">ì‚¬ìœ </label>
                                    <textarea id="specialReason" rows="3" class="w-full border rounded-md px-3 py-2"
                                        placeholder="íŠ¹ë³„ ë°°ì°¨ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-1">ìš°ì„ ìˆœìœ„</label>
                                    <select id="priority" class="w-full border rounded-md px-3 py-2">
                                        <option value="normal">ì¼ë°˜</option>
                                        <option value="urgent">ê¸´ê¸‰</option>
                                        <option value="critical">ë§¤ìš° ê¸´ê¸‰</option>
                                    </select>
                                </div>

                                <button id="submitSpecial"
                                    class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-medium">
                                    ğŸš¨ íŠ¹ë³„ ë°°ì°¨ ì‹ ì²­
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- íŠ¹ë³„ ë°°ì°¨ í˜„í™© -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-4 border-b">
                                <h3 class="text-lg font-semibold">ğŸš¨ íŠ¹ë³„ ë°°ì°¨ í˜„í™©</h3>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ì‹ ì²­ì‹œê°„</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ìœ í˜•</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">í•™ìƒ/ì‚¬ìœ </th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ìš°ì„ ìˆœìœ„</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ìƒíƒœ</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ì•¡ì…˜</th>
                                        </tr>
                                    </thead>
                                    <tbody id="specialDispatchTable">
                                        <tr>
                                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                                íŠ¹ë³„ ë°°ì°¨ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë°°ì°¨ ì´ë ¥ íƒ­ -->
            <div id="historyTab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold">ğŸ“Š ë°°ì°¨ ì´ë ¥</h3>
                        <div class="flex gap-2">
                            <input type="date" id="historyFrom" class="border rounded-md px-3 py-2 text-sm">
                            <input type="date" id="historyTo" value="{{ today_str }}"
                                class="border rounded-md px-3 py-2 text-sm">
                            <button id="searchHistory"
                                class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                                ğŸ” ì¡°íšŒ
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ë‚ ì§œ</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">í´ë˜ìŠ¤</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ê¸°ì‚¬</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">í•™ìƒìˆ˜</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ì™„ë£Œì‹œê°„</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">í‰ê°€</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                        ì¡°íšŒ ê¸°ê°„ì„ ì„ íƒí•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ì„ íƒ ëª¨ë‹¬ -->
    <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full max-h-96">
                <div class="p-4 border-b">
                    <h3 class="text-lg font-bold">í•™ìƒ ì„ íƒ</h3>
                </div>
                <div class="p-4 max-h-64 overflow-y-auto">
                    <div class="space-y-2" id="studentList">
                        <!-- í•™ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <div class="p-4 border-t flex gap-2">
                    <button id="confirmStudent" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                        í™•ì¸
                    </button>
                    <button id="cancelStudent" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Flaskì—ì„œ ì „ë‹¬ë°›ì€ ì‚¬ìš©ì ì •ë³´
        const currentUser = {
            role: '{{ current_user.role }}',
            branchId: {{ current_user.branch_id if current_user.branch_id else 'null' }},
        branchName: '{{ current_user.managed_branch.name if current_user.managed_branch else "ë¯¸ì„¤ì •" }}',
            name: '{{ current_user.name }}',
                permissions: ['view_dispatch', 'create_dispatch', 'manage_special_dispatch']
        };

        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í´ë˜ìŠ¤ ë°ì´í„°
        const availableClasses = [
            {% for class_item in available_classes %}
        {
            id: { { class_item.id } },
            name: '{{ class_item.name }}',
                timeSlots: [
                    {% for time_slot in class_item.time_slots %}
        '{{ time_slot.time }}'{% if not loop.last %}, {% endif %}
        {% endfor %}
                ]
            }{% if not loop.last %}, {% endif %}
        {% endfor %}
        ];

        // ê¸€ë¡œë²Œ ë³€ìˆ˜
        let currentDispatches = [];
        let selectedStudents = [];
        let isLoading = false;

        // âœ… 1. ì´ˆê¸°í™” í•¨ìˆ˜ ê°œì„ 
        function initialize() {
            const today = new Date();
            document.getElementById('dispatchDate').value = today.toISOString().split('T')[0];

            // ì´ë ¥ ì¡°íšŒ ì‹œì‘ ë‚ ì§œ (7ì¼ ì „)
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            document.getElementById('historyFrom').value = weekAgo.toISOString().split('T')[0];

            setupEventListeners();
            updateResourceStatus();

            // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ë°°ì°¨ ëª©ë¡ ì¡°íšŒ
            loadDispatchList();
        }

        // âœ… 2. í”Œë˜ì‹œ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showFlashMessage(message, type = 'success') {
            const container = document.getElementById('flashMessages');
            const alertDiv = document.createElement('div');
            alertDiv.className = type === 'success' ? 'success-flash' : 'error-flash';
            alertDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-lg font-bold ml-4">&times;</button>
                </div>
            `;
            container.appendChild(alertDiv);

            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // âœ… 3. ë¡œë”© ìƒíƒœ ê´€ë¦¬
        function setLoading(loading) {
            isLoading = loading;
            const button = document.getElementById('generateRegular');
            if (loading) {
                button.disabled = true;
                button.innerHTML = 'â³ ìƒì„± ì¤‘...';
                button.classList.add('loading');
            } else {
                button.disabled = false;
                button.innerHTML = 'ğŸ“‹ ì •ê·œ ë°°ì°¨ ìƒì„±';
                button.classList.remove('loading');
            }
        }

        // âœ… 4. ê°œì„ ëœ ì •ê·œ ë°°ì°¨ ìƒì„± í•¨ìˆ˜
        function generateRegularDispatch() {
            if (isLoading) return;

            const selectedClass = document.getElementById('classSelect').value;
            const dispatchDate = document.getElementById('dispatchDate').value;
            const autoOptimize = document.getElementById('autoOptimize').checked;
            const autoAssign = document.getElementById('autoAssign').checked;

            if (!selectedClass) {
                showFlashMessage('í´ë˜ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            setLoading(true);

            // API í˜¸ì¶œ
            fetch('/api/dispatch/regular', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    class_name: selectedClass,
                    dispatch_date: dispatchDate,
                    auto_optimize: autoOptimize,
                    auto_assign: autoAssign
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    setLoading(false);
                    if (data.success) {
                        showFlashMessage(`ë°°ì°¨ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (${data.created_count || 1}ê°œ ë°°ì°¨)`, 'success');

                        // âœ… ì¤‘ìš”: ë°°ì°¨ ìƒì„± í›„ ì¦‰ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        setTimeout(() => {
                            loadDispatchList();
                            updateResourceStatus();
                        }, 500);

                    } else {
                        showFlashMessage('ë°°ì°¨ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                    }
                })
                .catch(error => {
                    setLoading(false);
                    console.error('Error:', error);
                    showFlashMessage('ë°°ì°¨ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                });
        }

        // âœ… 5. ê°œì„ ëœ ë°°ì°¨ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
        function loadDispatchList() {
            const today = document.getElementById('dispatchDate').value || new Date().toISOString().split('T')[0];

            fetch(`/api/dispatch/list?date=${today}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        currentDispatches = data.dispatches || [];
                        updateRegularDispatchTable(currentDispatches);
                        updateTodayStatus(currentDispatches);
                    } else {
                        console.error('ë°°ì°¨ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data.error);
                        updateRegularDispatchTable([]);
                    }
                })
                .catch(error => {
                    console.error('Error loading dispatch list:', error);
                    updateRegularDispatchTable([]);
                });
        }

        // âœ… 6. ê°œì„ ëœ ë°°ì°¨ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateRegularDispatchTable(dispatches = []) {
            const tbody = document.getElementById('regularDispatchTable');
            tbody.innerHTML = '';

            if (dispatches.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            ì˜¤ëŠ˜ ë°°ì°¨ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤
                        </td>
                    </tr>
                `;
                return;
            }

            dispatches.forEach((dispatch, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';

                // ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
                let statusClass = 'bg-gray-100 text-gray-800';
                let statusText = 'ëŒ€ê¸°';

                if (dispatch.status === 'assigned') {
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusText = 'ë°°ì •ë¨';
                } else if (dispatch.status === 'in_progress') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = 'ìš´í–‰ì¤‘';
                } else if (dispatch.status === 'completed') {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = 'ì™„ë£Œ';
                }

                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">#${dispatch.id || (index + 1)}</td>
                    <td class="px-4 py-3">${dispatch.class_name || '-'}</td>
                    <td class="px-4 py-3">
                        <div class="text-sm">
                            <div class="font-medium">${dispatch.driver_name || 'ë¯¸ë°°ì •'}</div>
                            <div class="text-gray-500">${dispatch.vehicle_name || 'ì°¨ëŸ‰ ë¯¸ë°°ì •'}</div>
                        </div>
                    </td>
                    <td class="px-4 py-3 font-bold text-blue-600">${dispatch.student_count || 0}ëª…</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="viewDispatchDetail('${dispatch.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 mr-1">
                            ìƒì„¸
                        </button>
                        ${dispatch.status === 'assigned' ?
                        `<button onclick="startDispatch('${dispatch.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">ì‹œì‘</button>` :
                        ''
                    }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // âœ… 7. ì˜¤ëŠ˜ ë°°ì°¨ í˜„í™© ì—…ë°ì´íŠ¸
        function updateTodayStatus(dispatches = []) {
            const operating = dispatches.filter(d => d.status === 'in_progress').length;
            const waiting = dispatches.filter(d => d.status === 'assigned').length;

            document.getElementById('operatingCount').textContent = operating;
            document.getElementById('waitingCount').textContent = waiting;
        }

        // âœ… 8. ë¦¬ì†ŒìŠ¤ í˜„í™© ì—…ë°ì´íŠ¸
        function updateResourceStatus() {
            fetch('/api/students/by-class?class_name=')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('waitingStudents').textContent = `${data.students.length}ëª…`;
                    }
                })
                .catch(() => {
                    document.getElementById('waitingStudents').textContent = 'ì¡°íšŒ ì‹¤íŒ¨';
                });
        }

        // âœ… 9. ê°œì„ ëœ ë°°ì°¨ ì´ë ¥ ì¡°íšŒ
        function searchDispatchHistory() {
            const fromDate = document.getElementById('historyFrom').value;
            const toDate = document.getElementById('historyTo').value;

            if (!fromDate || !toDate) {
                showFlashMessage('ì¡°íšŒ ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            fetch(`/api/dispatch/history?from_date=${fromDate}&to_date=${toDate}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateHistoryTable(data.history || []);
                    } else {
                        showFlashMessage('ë°°ì°¨ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: ' + data.error, 'error');
                        updateHistoryTable([]);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFlashMessage('ë°°ì°¨ ì´ë ¥ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    updateHistoryTable([]);
                });
        }

        // âœ… 10. ë°°ì°¨ ì´ë ¥ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateHistoryTable(historyData) {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';

            if (historyData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            ì„ íƒí•œ ê¸°ê°„ì— ë°°ì°¨ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤
                        </td>
                    </tr>
                `;
                return;
            }

            historyData.forEach(dayData => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${dayData.date_formatted}</td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${dayData.class_summary}</div>
                    </td>
                    <td class="px-4 py-3">${dayData.vehicles_used}ëŒ€ ìš´í–‰</td>
                    <td class="px-4 py-3 font-bold text-blue-600">${dayData.total_students}ëª…</td>
                    <td class="px-4 py-3">
                        <button onclick="viewDayDispatchDetail('${dayData.date}')" 
                                class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                            ìƒì„¸ë³´ê¸°
                        </button>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">ì™„ë£Œ</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('tab-inactive');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');

            // âœ… íƒ­ ì „í™˜ ì‹œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            if (tabName === 'regular') {
                loadDispatchList();
            } else if (tabName === 'history') {
                // ë°°ì°¨ ì´ë ¥ íƒ­ ì§„ì… ì‹œ ìë™ìœ¼ë¡œ ìµœê·¼ 7ì¼ ì¡°íšŒ
                setTimeout(searchDispatchHistory, 300);
            }
        }

        // ê¸°íƒ€ í•¨ìˆ˜ë“¤
        function viewDispatchDetail(dispatchId) {
            // ë°°ì°¨ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ ë¡œì§
            showFlashMessage(`ë°°ì°¨ #${dispatchId} ìƒì„¸ ì •ë³´ (ê°œë°œ ì¤‘)`, 'success');
        }

        function startDispatch(dispatchId) {
            // ë°°ì°¨ ì‹œì‘ ë¡œì§
            if (confirm('ì´ ë°°ì°¨ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch(`/api/dispatch/${dispatchId}/start`, {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showFlashMessage('ë°°ì°¨ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                            loadDispatchList();
                        } else {
                            showFlashMessage('ë°°ì°¨ ì‹œì‘ ì‹¤íŒ¨: ' + data.error, 'error');
                        }
                    });
            }
        }

        function viewDayDispatchDetail(date) {
            window.open(`/admin/dispatch/${date}`, '_blank');
        }

        // âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // íƒ­ ë²„íŠ¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // í´ë˜ìŠ¤ ì„ íƒ ë³€ê²½
            document.getElementById('classSelect').addEventListener('change', updateDispatchPreview);

            // ë°°ì°¨ ë‚ ì§œ ë³€ê²½
            document.getElementById('dispatchDate').addEventListener('change', () => {
                loadDispatchList(); // ë‚ ì§œ ë³€ê²½ ì‹œ í•´ë‹¹ ë‚ ì§œ ë°°ì°¨ ëª©ë¡ ë¡œë“œ
            });

            // ì •ê·œ ë°°ì°¨ ìƒì„±
            document.getElementById('generateRegular').addEventListener('click', generateRegularDispatch);

            // ì´ë ¥ ì¡°íšŒ
            document.getElementById('searchHistory').addEventListener('click', searchDispatchHistory);

            // ìƒˆë¡œê³ ì¹¨
            document.getElementById('refreshDispatch').addEventListener('click', refreshDispatchData);


            loadDispatchList();
            updateResourceStatus();
            showFlashMessage('ë°°ì°¨ í˜„í™©ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        });

        // ë‚´ë³´ë‚´ê¸°
        document.getElementById('exportDispatch').addEventListener('click', exportDispatchData);
        }

        // âœ… ë°°ì°¨ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateDispatchPreview() {
            const selectedClass = document.getElementById('classSelect').value;
            const previewElement = document.getElementById('dispatchPreview');

            if (!selectedClass) {
                previewElement.textContent = 'í´ë˜ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ ì˜ˆìƒ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤';
                return;
            }

            previewElement.innerHTML = '<div class="text-gray-500">â³ ì •ë³´ ì¡°íšŒ ì¤‘...</div>';

            fetch('/api/dispatch/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    class_name: selectedClass,
                    dispatch_date: document.getElementById('dispatchDate').value
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const studentsPerVehicle = Math.ceil(data.student_count / data.estimated_vehicles);
                        previewElement.innerHTML = `
                        <div>ğŸ“š ëŒ€ìƒ í•™ìƒ: <strong>${data.student_count}ëª…</strong></div>
                        <div>ğŸš í•„ìš” ì°¨ëŸ‰: <strong>${data.estimated_vehicles}ëŒ€</strong></div>
                        <div>ğŸ‘¥ ì°¨ëŸ‰ë‹¹ í‰ê· : <strong>${studentsPerVehicle}ëª…</strong></div>
                        <div class="text-gray-600 mt-1">â±ï¸ ì˜ˆìƒ ì†Œìš”: ${data.estimated_time || '15-25'}ë¶„</div>
                    `;
                    } else {
                        previewElement.innerHTML = '<div class="text-red-600">âŒ ' + (data.error || 'ì¡°íšŒ ì‹¤íŒ¨') + '</div>';
                    }
                })
                .catch(() => {
                    previewElement.innerHTML = '<div class="text-red-600">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</div>';
                });
        }

        // âœ… ê°œì„ ëœ ë°°ì°¨ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportDispatchData() {
            console.log('ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸° ì‹œì‘...');

            const today = document.getElementById('dispatchDate').value || new Date().toISOString().split('T')[0];

            // í˜„ì¬ í‘œì‹œëœ ë°°ì°¨ ë°ì´í„° í™•ì¸
            if (!currentDispatches || currentDispatches.length === 0) {
                showFlashMessage('âŒ ë‚´ë³´ë‚¼ ë°°ì°¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°°ì°¨ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // CSV í—¤ë”ì™€ ë°ì´í„° ìƒì„±
                const headers = ['ë°°ì°¨ë²ˆí˜¸', 'í´ë˜ìŠ¤', 'ê¸°ì‚¬ëª…', 'ì°¨ëŸ‰ë²ˆí˜¸', 'í•™ìƒìˆ˜', 'ìƒíƒœ', 'ìƒì„±ì‹œê°„'];
                const csvData = [headers];

                currentDispatches.forEach(dispatch => {
                    csvData.push([
                        dispatch.id || '',
                        dispatch.class_name || 'ë¯¸ì§€ì •',
                        dispatch.driver_name || 'ë¯¸ë°°ì •',
                        dispatch.vehicle_name || 'ë¯¸ë°°ì •',
                        dispatch.student_count || 0,
                        getStatusKorean(dispatch.status),
                        formatDateTime(dispatch.created_at) || ''
                    ]);
                });

                // CSV íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                const csvContent = csvData.map(row =>
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');

                const blob = new Blob(['\ufeff' + csvContent], {
                    type: 'text/csv;charset=utf-8;'
                });

                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ë°°ì°¨í˜„í™©_${today}.csv`);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // ë©”ëª¨ë¦¬ ì •ë¦¬
                URL.revokeObjectURL(url);

                showFlashMessage(`âœ… ë°°ì°¨ í˜„í™©ì´ CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (${currentDispatches.length}ê±´)`, 'success');
                console.log('ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!');

            } catch (error) {
                console.error('CSV ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showFlashMessage('âŒ CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // âœ… ìƒíƒœ í…ìŠ¤íŠ¸ í•œê¸€ ë³€í™˜ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
        function getStatusKorean(status) {
            const statusMap = {
                'pending': 'ëŒ€ê¸°ì¤‘',
                'assigned': 'ë°°ì •ì™„ë£Œ',
                'in_progress': 'ìš´í–‰ì¤‘',
                'completed': 'ì™„ë£Œ',
                'cancelled': 'ì·¨ì†Œë¨'
            };
            return statusMap[status] || 'ì•Œ ìˆ˜ ì—†ìŒ';
        }

        // âœ… ë‚ ì§œì‹œê°„ í¬ë§· í•¨ìˆ˜
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';

            try {
                const date = new Date(dateTimeStr);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');

                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§· ì˜¤ë¥˜:', error);
                return dateTimeStr;
            }
        }

        // âœ… ê°œì„ ëœ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
        function refreshDispatchData() {
            console.log('ğŸ”„ ë°°ì°¨ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const refreshBtn = document.getElementById('refreshDispatch');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨ ì¤‘...';
            }

            // ë°°ì°¨ ëª©ë¡ê³¼ ë¦¬ì†ŒìŠ¤ ìƒíƒœ ë™ì‹œ ì—…ë°ì´íŠ¸
            Promise.all([
                loadDispatchList(),
                updateResourceStatus()
            ]).then(() => {
                showFlashMessage('âœ… ë°°ì°¨ í˜„í™©ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                console.log('âœ… ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!');
            }).catch(error => {
                console.error('ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
                showFlashMessage('âŒ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }).finally(() => {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨';
                }
            });
        }

        // âœ… ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (HTMLì—ì„œ í˜¸ì¶œí•˜ê¸° ìœ„í•¨)
        window.viewDispatchDetail = viewDispatchDetail;
        window.startDispatch = startDispatch;
        window.viewDayDispatchDetail = viewDayDispatchDetail;
        window.refreshDispatchData = refreshDispatchData;
        window.exportDispatchData = exportDispatchData;

        // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš ë°°ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...');
            initialize();
            console.log('âœ… ë°°ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ!');
        });

        // âœ… í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (íƒ­ ì „í™˜ ë“±)
        document.addEventListener('visibilitychange', function () {
            if (!document.hidden) {
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì¼ ë•Œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    if (!document.getElementById('regularTab').classList.contains('hidden')) {
                        loadDispatchList();
                    }
                }, 1000);
            }
        });

        // âœ… API ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ 
        function handleApiError(error, operation = 'ì‘ì—…') {
            console.error(`API Error in ${operation}:`, error);

            let errorMessage = `${operation} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`;

            if (error.name === 'NetworkError' || !navigator.onLine) {
                errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            } else if (error.message.includes('404')) {
                errorMessage = 'API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            } else if (error.message.includes('500')) {
                errorMessage = 'ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }

            showFlashMessage(errorMessage, 'error');
        }

        // âœ… ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì„ íƒì  ê¸°ëŠ¥)
        function startRealTimeUpdates() {
            // 30ì´ˆë§ˆë‹¤ ë°°ì°¨ ìƒí™© ìë™ ì—…ë°ì´íŠ¸
            setInterval(() => {
                if (!document.hidden && !isLoading) {
                    loadDispatchList();
                }
            }, 30000);
        }

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘ (í˜ì´ì§€ ë¡œë“œ 2ë¶„ í›„)
        setTimeout(startRealTimeUpdates, 120000);

        // âœ… ë””ë²„ê¹…ìš© í•¨ìˆ˜ (ê°œë°œì ë„êµ¬ì—ì„œ ì‚¬ìš©)
        function debugButtonStatus() {
            console.log('ğŸ” ë²„íŠ¼ ìƒíƒœ ë””ë²„ê¹…:');
            console.log('- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼:', document.getElementById('refreshDispatch') ? 'âœ… ì¡´ì¬' : 'âŒ ì—†ìŒ');
            console.log('- ë‚´ë³´ë‚´ê¸° ë²„íŠ¼:', document.getElementById('exportDispatch') ? 'âœ… ì¡´ì¬' : 'âŒ ì—†ìŒ');
            console.log('- currentDispatches ë°ì´í„°:', currentDispatches ? `${currentDispatches.length}ê±´` : 'âŒ ì—†ìŒ');
            console.log('- í˜„ì¬ ë‚ ì§œ:', document.getElementById('dispatchDate').value);
        }

        // ì „ì—­ì—ì„œ ë””ë²„ê¹… í•¨ìˆ˜ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
        window.debugButtonStatus = debugButtonStatus;

    </script>
</body>

</html>